# План разработки: Интеграция Toshik Chat и Toshik Babe

Этот документ описывает пошаговый план перехода фронтенда `toshik-chat` на новый бэкенд `toshik-babe` (Bun + TypeScript), в соответствии с PRD v1.1.

**Цель:** Полный отказ от OpenClaw Gateway в пользу суверенного бэкенда на Bun.

---

## Фаза 0: Очистка и Подготовка (Cleanup & Decoupling)

**Цель:** Изолировать логику текущего WebSocket-протокола OpenClaw в React-приложении, чтобы замена бэкенда прошла безболезненно для UI компонентов.

### Шаги:
1.  **Абстракция API клиента**:
    *   Создать интерфейс `ChatClient` в `toshik-chat/src/api/types.ts`, описывающий методы: `connect()`, `disconnect()`, `send(text, attachments)`, `on(event, callback)`.
    *   Переименовать текущий `useToshikWs` в `useOpenClawWs` (как легаси-реализацию).
    *   Создать заглушку `useToshikBabeWs`, реализующую тот же интерфейс.

2.  **Очистка типов**:
    *   Вынести типы сообщений OpenClaw (`ConnectReq`, `kind: connect_challenge` и т.д.) в отдельный файл `legacy_types.ts`.
    *   Подготовить новые типы для Toshik Babe (на основе PRD):
        ```typescript
        type BaseMsg = {
          type: 'cmd' | 'event' | 'req' | 'res';
          id: string; // correlation_id
          timestamp: number;
        };
        ```

3.  **UI Подготовка**:
    *   Убедиться, что компоненты чата (список сообщений, ввод) не зависят от внутренней структуры WebSocket-сообщений, а принимают унифицированные объекты `Message`.

---

## Фаза 1: Рукопожатие (Handshake)

**Цель:** Реализовать базовый коммуникационный слой между Bun и React по новому протоколу.

### Бэкенд (`toshik-babe`):
1.  **Структура сервера**:
    *   Разделить `index.ts` на модули: `server/websocket.ts`, `server/router.ts`.
    *   Реализовать валидацию входящих сообщений (Zod или TypeBox).
2.  **Протокол**:
    *   Реализовать обработку `type: 'req', method: 'handshake'`.
    *   Сервер должен отвечать `type: 'res', ok: true, serverTime: ...`.
3.  **Heartbeat**:
    *   Добавить Ping/Pong механику (каждые 30 сек), разрыв соединения при таймауте.

### Фронтенд (`toshik-chat`):
1.  **Реализация хука**:
    *   В `useToshikBabeWs` реализовать подключение к `ws://localhost:3000/ws`.
    *   Автоматическая отправка handshake при `onopen`.
    *   Обработка переподключений (exponential backoff).
2.  **Индикатор статуса**:
    *   Вывести статус соединения (Connected/Offline) в хедер чата.

---

## Фаза 2: Интеграция ИИ (AI Integration)

**Цель:** Заменить эхо-ответы на реальную генерацию текста через LLM.

### Бэкенд (`toshik-babe`):
1.  **Model Adapter Layer**:
    *   Создать интерфейс `LLMProvider` (методы `chat`, `stream`).
    *   Реализовать адаптер для OpenAI API (или совместимого локального сервера, например, Ollama).
    *   *Техническое решение:* Использовать нативный `fetch` в Bun или официальные SDK.
2.  **Streaming Handler**:
    *   Обработка сообщения `chat.send` от клиента.
    *   Преобразование стрима от LLM в WebSocket-сообщения `type: 'event', kind: 'chat_delta'`.
    *   Поддержка отмены генерации (клиент шлет `chat.cancel` -> сервер обрывает стрим).

### Фронтенд (`toshik-chat`):
1.  **Отображение стрима**:
    *   Обновление последнего сообщения в стейте по мере прихода чанков `chat_delta`.
2.  **Markdown & Code**:
    *   Убедиться, что `react-markdown` корректно рендерит незавершенные блоки кода (во время стриминга).

---

## Фаза 3: Дашборд (The Dashboard)

**Цель:** Реализовать правую панель (Context Widget), описанную в PRD.

### Фронтенд (`toshik-chat`):
1.  **Layout**:
    *   Использовать Mantine Grid или Flex для создания двухколоночного макета.
    *   Правая панель (ширина 30-40%) должна скрываться/показываться.
2.  **Widget Store**:
    *   Создать Zustand стор (или контекст) для хранения состояния виджетов.
    *   Виджеты: `FilePreview`, `RagContext`, `CodeSnippet`.

### Бэкенд (`toshik-babe`):
1.  **Context Analysis**:
    *   Простейшая логика: если в ответе LLM есть блок кода, отправлять событие `widget_update` с типом `code`.
    *   Если пользователь загрузил файл, отправлять `widget_update` с типом `file`.

---

## Фаза 4: Локальное хранение и RAG (Local Storage & RAG)

**Цель:** Сохранять историю и контекст между перезапусками.

### Бэкенд (`toshik-babe`):
1.  **SQLite**:
    *   Подключить `bun:sqlite`.
    *   Схема БД:
        *   `sessions` (id, title, created_at)
        *   `messages` (id, session_id, role, content, type)
2.  **CRUD API**:
    *   Добавить WebSocket-команды: `history.list`, `history.get`, `session.create`.
3.  **Векторный поиск (Start)**:
    *   Добавить таблицу `embeddings` (или использовать расширение `sqlite-vec`, если доступно в Bun, иначе — простая реализация in-memory для начала).
    *   При сохранении сообщения пользователя -> генерировать эмбеддинг -> сохранять.
    *   Перед запросом к LLM -> поиск похожих сообщений -> добавление в System Prompt.

### Фронтенд (`toshik-chat`):
1.  **Sidebar**:
    *   Левая панель со списком прошлых чатов (загрузка через `history.list`).
2.  **Восстановление контекста**:
    *   При клике на чат -> `history.get` -> заполнение стейта сообщениями.

---

## Технические требования к реализации

*   **Язык**: TypeScript (Strict mode).
*   **Стиль кода**: Prettier + ESLint.
*   **Безопасность**: Валидация всех входящих данных на бэкенде (Zod).
*   **Логирование**: Структурированные логи в консоль сервера.
